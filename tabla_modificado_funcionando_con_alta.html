<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Control de REDMINE</title>
<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif !important; 'Segoe UI', sans-serif; background: #f4f6f8; color: #2c3e50; padding: 20px; }
    header {
      background: #2c3e50; color: white; padding: 20px;
      display: flex; align-items: center; justify-content: space-between;
      gap: 15px; margin-bottom: 20px; flex-wrap: wrap;
    }
    header img { height: 80px; }
    h1 { font-size: 24px; text-transform: uppercase; }
    nav.header-nav { width: 100%; margin-top: 10px; }
    nav.header-nav a { color: #4fc3f7; text-decoration: none; font-weight: bold; margin-right: 15px; }
    nav.header-nav a:hover { text-decoration: underline; }
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; font-size: 14px; }
    th { background-color: #34495e; color: white; text-transform: uppercase; }
    tr:hover { background-color: #f1f1f1; }
    .detalle-btn { cursor: pointer; color: #3498db; font-weight: bold; font-size: 18px; text-align: center; transition: transform 0.2s; }
    .detalle-btn:hover { transform: scale(1.2); }
    .subtabla { animation: fadeIn 0.3s ease; background-color: #bdc3c7; }
    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    select { margin-top: 10px; padding: 5px; font-size: 14px; }
    body {
      background-color: #1e1e2f !important;
      color: #f0f0f0 !important;
    }
    table {
      background-color: #2c2c3c !important;
      color: #ffffff !important;
    }
    th {
      background-color: #1b1b2a !important;
    }
    tr:hover {
      background-color: #33334d !important;
    }
    input, select {
      background-color: #2e2e3e !important;
      color: #ffffff !important;
      border: 1px solid #444 !important;
    }
    .modal {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, 0);
      background-color: #2c2c3c;
      padding: 20px;
      border: 2px solid #555;
      border-radius: 8px;
      z-index: 1000;
      color: white;
      width: 350px;
      display: none;
    }
    .modal input, .modal select {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
    }
    .modal button {
      padding: 8px 12px;
      margin-right: 10px;
      background-color: #34495e;
      border: none;
      color: white;
      cursor: pointer;
    }
    a {
      color: #4fc3f7 !important;
      text-decoration: underline;
    }
    .subtabla {
      background-color: #29293d !important;
      color: #e0e0e0 !important;
    }
    .subtabla table td {
      padding: 4px 8px;
    }

.tag-label {
  display: inline-block;
  background-color: #d3d3d3;
  color: #000;
  padding: 2px 6px;
  margin: 2px 4px 2px 0;
  border-radius: 4px;
  font-size: 12px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const ESTADO_INTERNO_MAP = {
  "11": "En An√°lisis | BACKLOG",
  "12": "En An√°lisis | EN CURSO",
  "13": "En An√°lisis | DEV. POR DESA",
  "14": "En Desarrollo | STAND BY",
  "15": "En Desarrollo | EN CURSO",
  "16": "En Prueba Func. | EN CURSO",
  "17": "En Prueba QA | BACKLOG",
  "18": "En Prueba QA | EN CURSO",
  "19": "Solicitud de Pasaje a PROD.",
  "20": "CERRADOS / En PROD."
};
function normalizarEstadoInterno(valor) {
  if (!valor) return "";
  const clave = parseInt(valor).toString();
  return ESTADO_INTERNO_MAP[clave] || valor;
}
function desnormalizarEstadoInterno(texto) {
  for (const [clave, descripcion] of Object.entries(ESTADO_INTERNO_MAP)) {
    if (descripcion === texto) return clave;
  }
  return texto;
}
function actualizarHora() {
  const now = new Date();
  const dias = ["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"];
  const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
  const diaNombre = dias[now.getDay()];
  const dia = now.getDate();
  const mes = meses[now.getMonth()];
  const anio = now.getFullYear();
  const horas = String(now.getHours()).padStart(2,'0');
  const minutos = String(now.getMinutes()).padStart(2,'0');
  document.getElementById("fechaHora").textContent = `${diaNombre}, ${dia} de ${mes} de ${anio} | ${horas}:${minutos}`;
}
window.onload = () => {
  actualizarHora();
};
</script>
</head>
<body>
<nav style="background-color:#1b1b2a; padding: 8px 20px; font-family: 'Segoe UI', sans-serif; font-size: 14px;">
<div style="position: relative; display: inline-block;">
<span id="vistasToggle" style="color: #f0f0f0; cursor: pointer;">Vistas ‚ñæ</span>
<div class="dropdown-content" id="menuVistas" style="display:none; position: absolute; background-color: #2c2c3c; min-width: 150px; z-index: 10; border: 1px solid #444; border-radius: 4px;">
<a href="tabla_modificado.html" style="color: #f0f0f0; padding: 10px 12px; display: flex; align-items: center; gap: 8px; text-decoration: none;">
<svg fill="#4fc3f7" height="16" viewbox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M3 3h8v8H3V3zm0 10h8v8H3v-8zm10-10h8v8h-8V3zm0 10h8v8h-8v-8z"></path></svg>
        Tabla
      </a>
<a href="kanban_modificado.html" style="color: #f0f0f0; padding: 10px 12px; display: flex; align-items: center; gap: 8px; text-decoration: none;">
<svg fill="#4fc3f7" height="16" viewbox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M3 5v14h6V5H3zm12 0v14h6V5h-6zM10 9v6h4V9h-4z"></path></svg>
        Tablero
      </a>
</div>
</div>
</nav>
<script>
  const toggle = document.getElementById("vistasToggle");
  const menu = document.getElementById("menuVistas");

  toggle.addEventListener("click", function (event) {
    event.stopPropagation();
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
  });

  window.addEventListener("click", function () {
    if (menu.style.display === "block") {
      menu.style.display = "none";
    }
  });

  menu.addEventListener("click", function (e) {
    e.stopPropagation();
  });
</script>
<script>
  window.onclick = function(event) {
    if (!event.target.matches('span')) {
      var dropdowns = document.getElementsByClassName("dropdown-content");
      for (var i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
          openDropdown.classList.remove('show');
          openDropdown.style.display = 'none';
        }
      }
    } else {
      var menu = document.getElementById("menuVistas");
      if (menu.style.display === "block") {
        menu.style.display = "none";
      } else {
        menu.style.display = "block";
      }
    }
  }
</script>
<header style="background-color: #2c3e50; color: white; padding: 8px 20px; display: flex; align-items: center; justify-content: space-between; height: 48px;">
<div style="display: flex; align-items: center; gap: 10px;">
<img alt="Logo" src="logo.png" style="height: 36px;"/>
<span style="font-size: 16px; font-weight: bold; font-family: 'Segoe UI', sans-serif;">TICKET CONTROL</span>
</div>
<div id="fechaHora" style="border-left: 1px solid #ccc; padding-left: 10px; font-size: 14px; font-weight: bold;"></div>
</header>
<script>
function actualizarFechaHora() {
  const now = new Date();
  const dias = ["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"];
  const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
  const dia = dias[now.getDay()];
  const fecha = `${dia}, ${now.getDate()} de ${meses[now.getMonth()]} de ${now.getFullYear()}`;
  const hora = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  document.getElementById("fechaHora").textContent = `${fecha} | ${hora}`;
}
setInterval(actualizarFechaHora, 1000);
actualizarFechaHora();
</script>
<div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
<input accept=".csv" id="archivoIssues" type="file"/>
<button onclick="actualizarBD()">üîÑ Actualizar existentes</button>
<button onclick="forzarRecarga()" style="background-color: #e67e22; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">üîÉ Forzar Recarga de GitHub</button></div><div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px;">
<button onclick="limpiarFiltros()" style="background-color: #8e44ad; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">
  Limpiar Filtros
</button>
<label>Sistema:
    <select id="filtroSistema" style="width: 180px; height: 30px; padding: 5px; font-size: 14px;"><option value="">-- Todos --</option></select>
</label>
<label>Estado Interno:
    <select id="filtroEstado" style="width: 180px; height: 30px; padding: 5px; font-size: 14px;"><option value="">-- Todos --</option></select>
</label>
<label>RM:
    <input id="filtroRM" placeholder="Nro RM" style="width: 180px; height: 30px; padding: 5px; font-size: 14px;" type="number"/>
</label>
<label>Estado:
    <select id="filtroEstadoExterno" style="width: 180px; height: 30px; padding: 5px; font-size: 14px;"><option value="">-- Todos --</option></select>
</label>
<label>Prioridad:
    <select id="filtroPrioridad" style="width: 180px; height: 30px; padding: 5px; font-size: 14px;"><option value="">-- Todos --</option></select>
</label>
<label>Asignado a:
    <select id="filtroAsignado" style="width: 180px; height: 30px; padding: 5px; font-size: 14px;"><option value="">-- Todos --</option></select>
</label>
<label>Actualizado:
    <input id="filtroFecha" style="width: 180px; height: 30px; padding: 5px; font-size: 14px;" type="date"/>
</label>
<label>Funcional Responsable:
    <select id="filtroFuncional" style="width: 180px; height: 30px; padding: 5px; font-size: 14px;">
<option value="">-- Todos --</option>
</select>
</label>
<label>TAGS:
    <select id="filtroTags" style="width: 180px; height: 30px; padding: 5px; font-size: 14px;">
<option value="">-- Todos --</option>
</select>
</label>
<label>
<input id="ocultarCerrados" onchange="aplicarFiltros()" type="checkbox"/>
  Ocultar cerrados
</label>
</div>
<style>
  .action-bar { margin-top: 20px; display: flex; gap: 10px; }
  .action-bar button {
    padding: 8px 16px; font-size: 14px; cursor: pointer;
    border: none; border-radius: 4px; background-color: #2c3e50; color: white;
    transition: background-color 0.3s ease;
  }
  .action-bar button:hover { background-color: #34495e; }
  .highlight-link {
    font-weight: bold; color: #4fc3f7 !important; text-decoration: none;
  }
  .action-bar { justify-content: space-between !important; align-items: center; font-family: 'Segoe UI', sans-serif !important; }
  .action-bar a {
    margin-left: auto; color: #4fc3f7 !important; font-family: 'Segoe UI', sans-serif !important;
  }
  button, select, label, h1, input, a { font-family: 'Segoe UI', sans-serif !important; }
</style>
<div class="action-bar">
<a class="highlight-link" href="https://github.com/darioelola/Archivos/blob/main/BD_RM.csv" target="_blank">Base de Datos RM üìÅ</a>
</div>
<script>
let usuarioAutenticado = "usuario_demo";
function crearNuevoRegistro() {
  const sistema = prompt("Ingrese SISTEMA (OBSBA o CIUDAD):");
  const estado = prompt("Seleccione ESTADO INTERNO:\n" + Object.keys(ESTADOS_ORDENADOS).join("\n"));
  const rm = parseInt(prompt("Ingrese n√∫mero de RM:"), 10);
  if (!sistema || !estado || isNaN(rm)) { alert("Todos los campos son obligatorios."); return; }
  const nuevo = {
    "SISTEMA": sistema, "ESTADO INTERNO": estado, "RM": rm,
    "Asunto": "Nuevo registro", "Estado": "", "Prioridad": "",
    "Asignado a": "", "Actualizado": new Date().toISOString().split("T")[0],
    "Actualizado por": usuarioAutenticado
  };
  nuevo["_ordenEstado"] = encontrarEstadoMatch(estado);
  fullData.push(nuevo);
  pintarTabla(fullData);
}
function exportarCSV() {
  const headers = Object.keys(fullData[0]).filter(k => !k.startsWith("_"));
  const csv = Papa.unparse(fullData.map(row => {
    const r = {}; headers.forEach(h => r[h] = row[h]); return r;
  }));
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
  link.setAttribute("download", "BD_RM_actualizado.csv");
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
}
</script>
<div style="margin: 15px 0; display: flex; justify-content: flex-end;">
<button id="btnExportarExcel" style="background-color:#27ae60; color:white; padding:8px 16px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">
    üìä Descargar Excel Ejecutivo
  </button>
</div>
<table id="mainTable">
<thead>
<tr><th>Detalle</th><th>SISTEMA</th><th><span onclick="cambiarOrden('estado')" style="cursor:pointer;">ESTADO INTERNO ‚¨ç</span></th><th>RM</th><th>Asunto</th><th>Estado</th><th>Prioridad</th><th>Asignado a</th><th><span onclick="cambiarOrden('fecha')" style="cursor:pointer;">ACTUALIZADO ‚¨ç</span></th><th>FUNCIONAL RESPONSABLE</th><th>TAGS</th></tr>
</thead>
<tbody></tbody>
</table>
<script>
const CSV_URL = 'https://raw.githubusercontent.com/darioelola/Archivos/main/BD_RM.csv';
const ESTADOS_ORDENADOS = {
  "En An√°lisis | BACKLOG": "11 ", "En An√°lisis | EN CURSO": "12 ",
  "En An√°lisis | DEV. POR DESA": "13 ", "En Desarrollo | STAND BY": "14 ",
  "En Desarrollo | EN CURSO": "15 ", "En Prueba Func. | EN CURSO": "16 ",
  "En Prueba QA | BACKLOG": "17 ", "En Prueba QA | EN CURSO": "18 ",
  "Solicitud de Pasaje a PROD.": "19 ", "CERRADOS / En PROD.": "20 "
};
function encontrarEstadoMatch(estadoBuscado) {
  estadoBuscado = (estadoBuscado || "").toLowerCase().trim();
  let mejorCoincidencia = null, mejorScore = 0;
  for (const [estadoDefinido, orden] of Object.entries(ESTADOS_ORDENADOS)) {
    const estadoComparar = estadoDefinido.toLowerCase().trim();
    const coincidencia = calcularCoincidencia(estadoBuscado, estadoComparar);
    if (coincidencia > mejorScore) { mejorScore = coincidencia; mejorCoincidencia = orden; }
  }
  return mejorScore >= 0.98 ? mejorCoincidencia : "99 ";
}
function calcularCoincidencia(a, b) {
  if (a === b) return 1.0;
  const aTokens = a.split(/\s+/), bTokens = b.split(/\s+/);
  const comunes = aTokens.filter(token => bTokens.includes(token)).length;
  const total = Math.max(aTokens.length, bTokens.length);
  return comunes / total;
}
let fullData = [];
function cargarCSV() {
  fetch(CSV_URL + '?t=' + new Date().getTime())
    .then(res => res.text()).then(text => {
      Papa.parse(text, { header:true, skipEmptyLines:true, complete: results => {
        fullData = results.data.map(row => {
          row["RM"] = parseInt(row["RM"]) || 0;
          row["ESTADO INTERNO"] = normalizarEstadoInterno(row["ESTADO INTERNO"]);
          row["_ordenEstado"] = desnormalizarEstadoInterno(row["ESTADO INTERNO"]);
      // Normalizar campo "levels"
      row["labels"] = row["labels"] || row["Labels"] || row["LABELS"] || "";
          return row;
        });
        cargarFiltro(); pintarTabla(fullData);
      }});
    });
}
let ordenEstadoAsc = true;
let ordenFechaDesc = true;

function cambiarOrden(columna) {
  if (columna === 'estado') ordenEstadoAsc = !ordenEstadoAsc;
  if (columna === 'fecha') ordenFechaDesc = !ordenFechaDesc;
  aplicarFiltros();
}

function pintarTabla(data) {
  const tbody = document.querySelector('#mainTable tbody'); tbody.innerHTML = '';
  data.sort((a,b) => {
    const cmpEstado = ordenEstadoAsc
      ? a["_ordenEstado"].localeCompare(b["_ordenEstado"])
      : b["_ordenEstado"].localeCompare(a["_ordenEstado"]);

    const cmpFecha = ordenFechaDesc
      ? new Date(b["Actualizado"]) - new Date(a["Actualizado"])
      : new Date(a["Actualizado"]) - new Date(b["Actualizado"]);

    if (cmpEstado !== 0) return cmpEstado;
    return cmpFecha;

    const cmp = a["_ordenEstado"].localeCompare(b["_ordenEstado"]);
    if (cmp !== 0) return cmp;
    return new Date(b["Actualizado"]) - new Date(a["Actualizado"]);
  });
  data.forEach(row => {
    const tr = document.createElement('tr'); 
    const tdDetalle = document.createElement('td');
    tdDetalle.innerHTML = '<span class="detalle-btn">‚ûï</span>';
    tdDetalle.onclick = () => toggleDetalle(row["RM"], tr);
    tr.appendChild(tdDetalle);
    ["SISTEMA","ESTADO INTERNO","RM","Asunto","Estado","Prioridad","Asignado a","Actualizado"].forEach(campo => {
      const td = document.createElement('td');
      if (campo === "ESTADO INTERNO") {
  const codigo = row["_ordenEstado"];
  const descripcion = ESTADO_INTERNO_MAP[codigo] || row["ESTADO INTERNO"];
  td.textContent = `${codigo} - ${descripcion}`;
}
      else if (campo==="RM") {
        const link = document.createElement("a");
        link.href = `https://redmine.dguiaf-gcba.gov.ar/issues/${row["RM"]}`;
        link.target = "_blank"; link.textContent = row["RM"];
        td.appendChild(link);
      } else td.textContent = row[campo]||"";
      tr.appendChild(td);
    });
    
    // Renderizar etiquetas
    const tdTags = document.createElement('td');
    const etiquetas = (row["labels"] || "").match(/\[(.*?)\]/g);
    if (etiquetas) {
        etiquetas.forEach(e => {
            const span = document.createElement('span');
            span.className = 'tag-label';
            span.textContent = e.replace(/\[|\]/g, '');
            tdTags.appendChild(span);
        });
    }
    
    // FUNCIONAL RESPONSABLE
    const tdFuncional = document.createElement('td');
    const matchFuncional = (row["labels"] || row["levels"] || "").match(/\|(.*?)\|/);
    if (matchFuncional) {
        const span = document.createElement('span');
        span.className = 'tag-label';
        span.textContent = matchFuncional[1];
        span.style.backgroundColor = '#006400'; // verde ingl√©s
        span.style.color = '#ffffff'; // texto blanco
        tdFuncional.appendChild(span);
    }
    tr.appendChild(tdFuncional);

    tr.appendChild(tdTags);
    tbody.appendChild(tr);
    
  });
}
function cargarFiltro() {
  const aplicarFiltrosEnTodos = () => aplicarFiltros();
  const campos = {
    "filtroSistema":"SISTEMA", "filtroEstado":"ESTADO INTERNO",
    "filtroEstadoExterno":"Estado", "filtroPrioridad":"Prioridad",
    "filtroAsignado":"Asignado a"
  };
  Object.entries(campos).forEach(([id,campo]) => {
    const select = document.getElementById(id);
    [...new Set(fullData.map(r=>r[campo]))].sort().forEach(val=>{
      const opt=document.createElement("option"); opt.value=val; opt.textContent=val;
      select.appendChild(opt);
    });
    select.addEventListener("change", aplicarFiltrosEnTodos);
  });
  document.getElementById("filtroRM").addEventListener("input", aplicarFiltrosEnTodos);
  document.getElementById("filtroFecha").addEventListener("change", aplicarFiltrosEnTodos);

  // Filtro de Tags
  const selectTags = document.getElementById("filtroTags");
  const etiquetasUnicas = new Set();
  fullData.forEach(r => {
    const etiquetas = (r["labels"] || r["Labels"] || "").match(/\[(.*?)\]/g);
    if (etiquetas) {
      etiquetas.forEach(e => etiquetasUnicas.add(e.replace(/\[|\]/g, '')));
    }
  });
  etiquetasUnicas.forEach(tag => {
    const opt = document.createElement("option");
    opt.value = tag;
    opt.textContent = tag;
    selectTags.appendChild(opt);
  });
  selectTags.addEventListener("change", aplicarFiltros);
  // Filtro FUNCIONAL RESPONSABLE
  const selectFuncional = document.getElementById("filtroFuncional");
  const responsables = new Set();
  fullData.forEach(r => {
    const match = (r["labels"] || r["levels"] || "").match(/\|(.*?)\|/);
    if (match) responsables.add(match[1]);
  });
  [...responsables].sort().forEach(val => {
    const opt = document.createElement("option");
    opt.value = val; opt.textContent = val;
    selectFuncional.appendChild(opt);
  });
  selectFuncional.addEventListener("change", aplicarFiltros);

        
  aplicarFiltrosEnTodos();
  if (document.getElementById("filtroFecha").value) aplicarFiltros();
  aplicarFiltrosEnTodos();
  if (document.getElementById("filtroFecha").value) aplicarFiltros();
  aplicarFiltros();
}
function toggleDetalle(rm, tr) {
  const next = tr.nextElementSibling;
  if (next && next.classList.contains("subtabla")) {
    next.remove(); tr.querySelector(".detalle-btn").textContent="‚ûï"; return;
  }
  const sub = document.createElement("tr"); sub.className="subtabla";
  const td = document.createElement("td"); td.colSpan=9;
  const detalle = fullData.find(d=>d.RM===rm);
  if (!detalle) td.textContent="Sin detalles disponibles.";
  else {
    let html="<strong>Detalle Completo:</strong><table style=\"margin-top:10px;\"><tbody>";
    Object.entries(detalle).forEach(([k,v])=>html+=`<tr><td><strong>${k}</strong></td><td>${v}</td></tr>`);
    html+="</tbody></table>"; td.innerHTML=html;
  }
  sub.appendChild(td); tr.parentNode.insertBefore(sub, tr.nextSibling);
  tr.querySelector(".detalle-btn").textContent="‚ûñ";
}
function aplicarFiltros() {
  const vals={
    sis:document.getElementById("filtroSistema").value,
    int:document.getElementById("filtroEstado").value,
    rm:document.getElementById("filtroRM").value,
    ext:document.getElementById("filtroEstadoExterno").value,
    pri:document.getElementById("filtroPrioridad").value,
    asi:document.getElementById("filtroAsignado").value,
    fec:document.getElementById("filtroFecha").value,
    tag:document.getElementById("filtroTags").value,
    fun:document.getElementById("filtroFuncional").value
  };
  
const ocultarCerrados = document.getElementById("ocultarCerrados").checked;
const filt = fullData.filter(r => {
  const esCerrado = r["_ordenEstado"] === "20";
  return (!ocultarCerrados || !esCerrado)
    && (!vals.tag || (r['labels'] && r['labels'].includes('['+vals.tag+']')))
    && (!vals.sis||r["SISTEMA"]===vals.sis)
    && (!vals.int||r["ESTADO INTERNO"]===vals.int)
    && (!vals.rm||r["RM"]==parseInt(vals.rm))
    && (!vals.ext||r["Estado"]===vals.ext)
    && (!vals.pri||r["Prioridad"]===vals.pri)
    && (!vals.asi||r["Asignado a"]===vals.asi)
    && (!vals.fec||r["Actualizado"].startsWith(vals.fec))
    && (!vals.fun || ((r["labels"] && r["labels"].includes("|" + vals.fun + "|"))));
});

  pintarTabla(filt);
}
cargarCSV();


  const filtroTags = document.getElementById("filtroTags");
  if (filtroTags && !filtroTags.dataset.populado) {
    const tagsUnicos = new Set();
    fullData.forEach(r => {
      const labels = r["labels"] || r["Labels"] || "";
      const matches = labels.match(/\[(.*?)\]/g);
      if (matches) matches.forEach(t => tagsUnicos.add(t.replace(/\[|\]/g, '')));
    });
    Array.from(tagsUnicos).sort().forEach(tag => {
      const opt = document.createElement("option");
      opt.value = tag; opt.textContent = tag;
      filtroTags.appendChild(opt);
    });
    filtroTags.dataset.populado = true;
  }
  filtroTags.addEventListener("change", aplicarFiltros);</script>
<script>
setInterval(actualizarHora, 1000);
</script>
<div class="modal" id="modalNuevoRegistro">
<h3>Nuevo Registro</h3>
<label>Sistema:</label>
<select id="nuevoSistema"><option value="OBSBA">OBSBA</option><option value="CIUDAD">CIUDAD</option></select>
<label>Estado Interno:</label>
<select id="nuevoEstado"></select>
<label>RM:</label>
<input id="nuevoRM" type="number"/>
<div style="text-align:right;">
<button onclick="confirmarNuevoRegistro()">Confirmar</button>
<button onclick="cerrarModal()">Cancelar</button>
</div>
</div>
<script>
// Funciones de modal y nuevo registro ya definidas arriba
function mostrarModal() {
  const sel = document.getElementById("nuevoEstado");
  sel.innerHTML = "";
  Object.entries(ESTADOS_ORDENADOS).forEach(([est, ord]) => {
    const opt = document.createElement("option");
    opt.value = est; opt.textContent = ord + est;
    sel.appendChild(opt);
  });
  document.getElementById("modalNuevoRegistro").style.display = "block";
}
function cerrarModal() { document.getElementById("modalNuevoRegistro").style.display = "none"; }
function confirmarNuevoRegistro() {
  const sis = document.getElementById("nuevoSistema").value;
  const est = document.getElementById("nuevoEstado").value;
  const rmv = parseInt(document.getElementById("nuevoRM").value);
  if (!sis||!est||isNaN(rmv)) { alert("Todos los campos son obligatorios."); return; }
  const nuevo = {"SISTEMA":sis,"ESTADO INTERNO":est,"RM":rmv,"Asunto":"Nuevo registro","Estado":"","Prioridad":"","Asignado a":"","Actualizado":new Date().toISOString().split("T")[0],"Actualizado por":usuarioAutenticado};
  nuevo["_ordenEstado"] = encontrarEstadoMatch(est);
  fullData.push(nuevo);
  cerrarModal(); pintarTabla(fullData);
}
</script>
<script>
function updateClock() {
  const now = new Date();
  const locale = 'es-AR';
  const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const time = now.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
  const date = now.toLocaleDateString(locale, opts);
  document.getElementById("clock").textContent = `${date} | ${time}`;
}
setInterval(updateClock, 1000);
updateClock();
</script>
<script>
const estadoInternoMap = {
  "B- Completo": 20, "B- Rechazado": 20, "E-Alcance": 11, "E-Backlog": 11, "E-Cancelada": 20,
  "E-Desarrollo": 15, "E-Produccion": 20, "E-Stand By": 11, "E-Test Funcional": 16, "E-Test QA": 18,
  "MDA-AnAAlisis": 11, "MDA-AnAlisis": 12, "MDA-Analisis": 12, "MDA-Cerrado": 20, "MDA-Desarrollo": 15,
  "MDA-Pasaje PROD": 19, "MDA-Pendiente usuario": 19, "MDA-Rechazado": 20, "MDA-Resuelto": 20,
  "MDA-Test QA": 18, "MDA-Test funcional": 16, "R- Backlog": 11, "R- En curso": 12,
  "T-Cancelada": 20, "T-Finalizada": 20, "T-En Curso": 15, "T-Pasaje a Producci√≥n": 19,
  "T-Stand By": 14, "T-Solicitud de pasaje": 19, "T-Pasaje a Produccion": 19
};
function similitud(str1, str2) {
  const a = str1.toLowerCase().split(/\W+/);
  const b = str2.toLowerCase().split(/\W+/);
  const comunes = a.filter(v => b.includes(v)).length;
  return comunes / Math.max(a.length, b.length);
}
function calcularEstadoInterno(estado) {
  let max = 0; let cod = "";
  for (let [key, val] of Object.entries(estadoInternoMap)) {
    let sim = similitud(estado, key);
    if (sim >= 0.9 && sim > max) { max = sim; cod = val; }
  }
  return cod || "";
}
function detectarSistema(proyecto) {
  return (proyecto.toUpperCase().includes("OBSBA")) ? "OBSBA" : "CIUDAD";
}
function actualizarBD() {
  const fileInput = document.getElementById("archivoIssues");
  if (!fileInput.files.length) return alert("Selecciona el archivo issues.csv");
  const reader = new FileReader();
  reader.onload = e => {
    const csv = e.target.result;
    const lines = csv.split(/\r?\n/);
    const headers = lines[0].split(";");
    const data = lines.slice(1).filter(Boolean).map(line => {
      const vals = line.split(";");
      const row = {}; headers.forEach((h, i) => row[h.trim()] = vals[i]?.trim());
      return row;
    });
    fetch("https://raw.githubusercontent.com/darioelola/Archivos/main/BD_RM.csv")
      .then(r => r.text()).then(text => {
        const bdLines = text.split(/\r?\n/);
        const bdHeaders = bdLines[0].split(",");
        let bd = bdLines.slice(1).filter(Boolean).map(line => {
          const vals = line.split(",");
          const row = {}; bdHeaders.forEach((h, i) => row[h.trim()] = vals[i]?.trim());
          return row;
        });
        
        data.forEach(issue => {
          const rm = issue["#"];
          let encontrado = bd.find(r => r["RM"] === rm);
          const estadoInterno = calcularEstadoInterno(issue["Estado"]);
          const sistema = detectarSistema(issue["Proyecto"]);
    
          if (encontrado) {
            encontrado["Proyecto"] = issue["Proyecto"];
            encontrado["Tipo"] = issue["Tipo"];
            encontrado["Tarea padre"] = issue["Tarea padre"];
            encontrado["Estado"] = issue["Estado"];
            encontrado["Prioridad"] = issue["Prioridad"];
            encontrado["Asunto"] = issue["Asunto"];
            encontrado["Actualizado por"] = issue["Actualizado por"];
            encontrado["Asignado a"] = issue["Asignado a"];
            encontrado["Actualizado"] = issue["Actualizado"];
            encontrado["Fecha de inicio"] = issue["Fecha de inicio"];
            encontrado["Fecha fin"] = issue["Fecha fin"];
            encontrado["Last updated by"] = issue["Last updated by"];
            if (estadoInterno) encontrado["ESTADO INTERNO"] = estadoInterno;
          } else {
            const nuevoRegistro = {
              "RM": rm,
              "Proyecto": issue["Proyecto"],
              "Tipo": issue["Tipo"],
              "Tarea padre": issue["Tarea padre"],
              "Estado": issue["Estado"],
              "Prioridad": issue["Prioridad"],
              "Asunto": issue["Asunto"],
              "Actualizado por": issue["Actualizado por"],
              "Asignado a": issue["Asignado a"],
              "Actualizado": issue["Actualizado"],
              "Fecha de inicio": issue["Fecha de inicio"],
              "Fecha fin": issue["Fecha fin"],
              "Last updated by": issue["Last updated by"],
              "ESTADO INTERNO": estadoInterno || "",
              "labels": issue["labels"] || ""
            };
            bd.push(nuevoRegistro);
          }
        });
    
        const final = bd;
        
        fullData = bd.map(row => {
          row["RM"] = parseInt(row["RM"]) || 0;
          row["ESTADO INTERNO"] = normalizarEstadoInterno(row["ESTADO INTERNO"]);
          row["_ordenEstado"] = desnormalizarEstadoInterno(row["ESTADO INTERNO"]);
      // Normalizar campo "levels"
      row["labels"] = row["labels"] || row["Labels"] || row["LABELS"] || "";
          return row;
        });

        pintarTabla(fullData);
    
const csvFinal = [bdHeaders.join(",")].concat(final.map(r => {
  return bdHeaders.map(h => {
    if (h === "ESTADO INTERNO") {
      return desnormalizarEstadoInterno(r["ESTADO INTERNO"]);
    }
    return r[h] || "";
  }).join(",");
})).join("\n");
        const blob = new Blob([csvFinal], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", "BD_RM_actualizado.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
  document.getElementById('archivoIssues').value = null;
      });
  };
  reader.readAsText(fileInput.files[0], "latin1");
}
</script>
<script>
function forzarRecarga() {
  cargarCSV();
  alert("La base de datos se ha recargado desde GitHub.");
}
</script></body>
</html>
<script>
function limpiarFiltros() {
  const ids = ["filtroSistema", "filtroEstado", "filtroRM", "filtroEstadoExterno", "filtroPrioridad", "filtroAsignado", "filtroFecha", "filtroTags"];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (el.tagName === "SELECT" || el.type === "date") {
        if (el.type === "date") { el.value = ""; } else { el.selectedIndex = 0; }
      } else {
        el.value = "";
      }
    }
  });
  aplicarFiltros();
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
document.getElementById("btnExportarExcel").addEventListener("click", () => {
  const table = document.querySelector("#mainTable");
  const wb = XLSX.utils.book_new();
  const ws_data = [["RM", "Asunto", "Sistema", "Estado Interno", "Estado", "Prioridad", "Asignado", "Actualizado", "Tags"]];

  const rows = Array.from(table.querySelectorAll("tbody tr"))
    .filter(row => !row.classList.contains("subtabla"));

  rows.forEach(row => {
    const tds = row.querySelectorAll("td");
    const estado = tds[2]?.textContent?.trim()?.split(" - ")[1] || "";
    if (["CERRADOS", "En PROD."].includes(estado) || estado === "20" || estado === "20.0") return;

    const rm = tds[3]?.textContent?.trim();
    const asunto = tds[4]?.textContent?.trim();
    const sistema = tds[1]?.textContent?.trim();
    const estadoExt = tds[5]?.textContent?.trim();
    const prioridad = tds[6]?.textContent?.trim();
    const asignado = tds[7]?.textContent?.trim();
    const actualizado = tds[8]?.textContent?.trim();
    const tags = Array.from(tds[9]?.querySelectorAll(".tag-label")).map(e => e.textContent).join(", ");
    ws_data.push([rm, asunto, sistema, estado, estadoExt, prioridad, asignado, actualizado, tags]);
  });

  const ws = XLSX.utils.aoa_to_sheet(ws_data);

  // Apply autofilter to the header row
  ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { c: 0, r: 0 }, e: { c: ws_data[0].length - 1, r: ws_data.length - 1 } }) };

  // Adjust column width
  ws['!cols'] = ws_data[0].map(() => ({ wch: 30 }));

  XLSX.utils.book_append_sheet(wb, ws, "Informe RM");
  XLSX.writeFile(wb, "Informe_RM_filtrado.xlsx");
});
</script>
