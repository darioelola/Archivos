<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Visualizador BD_RM</title>
<!-- Flatpickr CSS -->
<!-- Font Awesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
<!-- Estilos integrados -->
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
    background-color: #1e1e2f;
    color: #f0f0f0;
  }
  #tabla-container { overflow-x: auto; margin: 0 auto; width: 95%; }
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #2c2c3c;
    color: #ffffff;
  }
  th, td {
    padding: 10px;
    border: 1px solid #444;
    text-align: left;
    font-size: 14px;
  }
  th { background-color: #1b1b2a; }
  tr:hover { background-color: #33334d; }

  /* Inputs and selects (Filtros) */
  input, select {
    background-color: #2e2e3e;
    color: #f0f0f0;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 6px 8px;
    font-size: 13px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  input:hover, select:hover {
    border-color: #666;
  }
  input:focus, select:focus {
    outline: none;
    border-color: #6a6aff;
    box-shadow: 0 0 6px rgba(106, 106, 255, 0.5);
  }

  /* Botones */
  button {
    background-color: #3a3a50;
    color: #ffffff;
    border: 1px solid #5a5a75;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s, box-shadow 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  button:hover {
    background-color: #505060;
  }
  button:active {
    box-shadow: inset 0 0 5px rgba(0,0,0,0.4);
  }

  /* Barra de estado */
  .status-bar {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 12px; margin-bottom: 12px; border-radius: 4px;
    font-size: 14px; font-weight: bold; background: #282840; color: #e0e0e0;
    border: 1px solid #4a4a65;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }
  .status-bar.success { background: #245c33; color: #d0ffd0; }
  .status-bar.warn    { background: #7b0000; color: #ffe0e0; }

  a.rm-link {
    color: #4fc3f7;
    text-decoration: none;
    font-weight: bold;
  }
  a.rm-link:hover { text-decoration: underline; }

  .tag-label {
    display: inline-block;
    background: #d3d3d3;
    color: #000;
    padding: 2px 6px;
    margin: 2px 4px 2px 0;
    border-radius: 4px;
    font-size: 12px;
  }
  .tag-funcional {
    background: #006400 !important;
    color: #fff !important;
  }

  .modal-overlay {
    display: none;
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
  }
  .modal {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #ffffff;
    color: #333333;
    padding: 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 1000;
    width: 320px;
    display: none;
  }
  .modal h3 {
    margin: 0 0 16px;
    font-size: 1.2rem;
    color: #222222;
    text-align: center;
  }
  .modal input, .modal select {
    width: 100%;
    margin-bottom: 12px;
    padding: 8px;
    background: #f9f9f9;
    color: #333333;
    border: 1px solid #cccccc;
    border-radius: 4px;
    font-size: 14px;
  }
  .modal-btns {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  .modal-btns button {
    padding: 6px 16px;
    font-weight: bold;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .modal-btns button:first-child {
    background: #4a90e2;
    color: #ffffff;
  }
  .modal-btns button:first-child:hover {
    background: #357ab8;
  }
  .modal-btns button:last-child {
    background: #aaaaaa;
    color: #333333;
  }
  .modal-btns button:last-child:hover {
    background: #888888;
  }

  /* Resalte amarillo cuando coincida */
  .match-highlight {
    background-color: #ffff99 !important;
    color: #000000 !important;
  }
  tr.updated {
    background-color: #004d00 !important;
  }
</style>
</head>
<body>
<!-- ░░░ BARRA DE ESTADO + RELOJ ░░░ -->
<div class="status-bar" id="statusBar">
<span id="status">Sistema listo.</span>
<span id="statusClock"></span>
</div>
<!-- ---------- FILTROS ---------- -->
<div id="filtros-container"></div>
<div style="margin-bottom:12px">
<label style="color:#fff;margin-right:20px">
<input checked="" id="hideClosed" type="checkbox"/>
      Ocultar CERRADOS / En PROD.
    </label><label style="color:#fff;margin-right:20px"><input checked="" id="hideBacklog" type="checkbox"/> Ocultar En Análisis | BACKLOG.</label>
<button id="btnResetFilters">🔄 Restablecer Filtros</button>
</div>
<!-- ---------- BOTONES ACCIÓN ---------- -->
<div style="margin-bottom:15px">
<input accept=".csv" id="archivoIssues" style="display:none" type="file"/>
<button onclick="document.getElementById('archivoIssues').click()">📥 Importar issues.csv</button>
<button onclick="recomponerEstadosInternos()">🔄 Actualizar estados internos</button>
<button id="btnResetBD">🗑 Reiniciar BD</button>
<button id="btnNuevo">➕ Nuevo Registro</button>
<button id="btnSaveGit">💾 Guardar en GitHub</button>
<button onclick="forzarRecarga()">🔃 Recargar GitHub</button>
<button onclick="descargarExcel()">📄 Exportar Excel</button>
</div>
<!-- ---------- TABLA ---------- -->
<div id="tabla-container">
<table id="csv-table">
<thead id="csv-thead"></thead>
<tbody id="csv-tbody"></tbody>
</table>
</div>
<div id="pagination" style="margin-top:10px;text-align:center"></div>
<!-- Overlay para modales -->
<div class="modal-overlay" id="modalOverlay"></div>
<!-- ---------- MODAL NUEVO ---------- -->
<div class="modal" id="modalNuevo">
<h3>Nuevo Registro</h3>
<label>Número RM *</label>
<input id="nrRM" type="number"/>
<label>Sistema *</label>
<select id="nrSis">
<option value="OBSBA">OBSBA</option>
<option value="CIUDAD">CIUDAD</option>
</select>
<div class="modal-btns">
<button id="nrGuardar">Guardar</button>
<button onclick="cerrarModal('modalNuevo')">Cancelar</button>
</div>
</div>
<!-- ---------- MODAL EDITAR ---------- -->
<div class="modal" id="modalEdit">
<h3>Editar Registro</h3>
<label>Sistema</label>
<select id="edSis">
<option value="OBSBA">OBSBA</option>
<option value="CIUDAD">CIUDAD</option>
</select>
<label>Tags (, separados)</label>
<input id="edTags" type="text"/>
<div class="modal-btns">
<button id="edGuardar">Guardar</button>
<button onclick="cerrarModal('modalEdit')">Cancelar</button>
</div>
</div>
<!-- Librerías externas -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Lógica integrada con corrección de tags y recarga -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
      /* DESCARGAR EXCEL FILTRADO */
      window.descargarExcel = function() {
        const filtered = data.filter(r => {
          if ($chkHide.checked && (r["ESTADO INTERNO"]||"").includes("CERRADOS / En PROD.")) return false;
            if ($chkHideBacklog.checked && (r["ESTADO INTERNO"]||"").includes("En Análisis | BACKLOG")) return false;
          return filtros.every(({col,input}) => {
            if (!input.value) return true;
            let val = "";
            if (col === "TAGS") val = r["TAGS"] || "";
            else if (col === "FUNCIONAL Monitoreo") val = r["FUNCIONAL Monitoreo"] || "";
            else val = r[col] != null ? r[col].toString() : "";
            return val.toLowerCase().includes(input.value.toLowerCase());
          });
        });
        if (!filtered.length) {
          setStatus("⚠ No hay registros para exportar.","warn");
          return;
        }
        const exportData = filtered.map(r => {
          const obj = {};
          COLS.forEach(c => { obj[c] = r[c] || ""; });
          return obj;
        });
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Filtrado");
        XLSX.writeFile(wb, `TicketControl_${new Date().toISOString().split('T')[0]}.xlsx`);
        setStatus("✅ Excel descargado.","success");
      };

      /* CONFIGURACIÓN */
      const RAW_CSV_URL = new URL("BD_RM.csv", location.href).href;
      const LS_KEY_DATA = "BD_RM";
      const COLS = [
        "SISTEMA","ESTADO INTERNO","RM","Asunto",
        "Estado","Prioridad","Asignado a","Actualizado",
        "TAGS"
      ];
      const ROWS_X_PAG = 20;

      /* ESTADO */
      const $statusBar   = document.getElementById("statusBar");
      const $statusMsg   = document.getElementById("status");
      const $statusClock = document.getElementById("statusClock");
      const $fileIssues  = document.getElementById("archivoIssues");
      const $btnSaveGit  = document.getElementById("btnSaveGit");
      const $btnNuevo    = document.getElementById("btnNuevo");
      const $chkHide     = document.getElementById("hideClosed");
      const $chkHideBacklog = document.getElementById("hideBacklog");
      const $btnReset    = document.getElementById("btnResetFilters");
      const $thead       = document.getElementById("csv-thead");
      const $tbody       = document.getElementById("csv-tbody");
      const $pag         = document.getElementById("pagination");

      const filtros = [];    // { col, input }  
      let data = [];         // registros  
      let page = 1;          // página actual  
      let statusTimer;       // timeout para barra

      /* INICIALIZACIÓN */
      tickClock(); setInterval(tickClock, 1000);
      (async () => {
        // Cargar desde localStorage o GitHub
        const raw = localStorage.getItem(LS_KEY_DATA);
        if (raw) {
          try { data = JSON.parse(raw); } catch {}
        }
        if (!data.length) {
          setStatus("⬇️ Descargando BD_RM…");
          data = csvToArray(await fetchRawCSV());
          data = data.map(r => {
            r["TAGS"] = r["TAGS"] || "";
            r["FUNCIONAL Monitoreo"] = r["FUNCIONAL Monitoreo"] || "";
            return r;
          });
          localStorage.setItem(LS_KEY_DATA, JSON.stringify(data));
          setStatus("✔ Datos cargados","success");
        }
        window.data = data;
        buildUI();
        render();
      })();

      /* RELOJ y ESTADO */
      function tickClock() {
        const n = new Date();
        const fecha = n.toLocaleDateString("es-AR", {
          weekday: "long", year: "numeric", month: "long", day: "numeric"
        });
        const hora = n.toLocaleTimeString("es-AR", {
          hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
        });
        $statusClock.textContent = `${fecha} | ${hora}`;
      }
      function setStatus(msg, kind = "info") {
        $statusMsg.textContent = msg;
        $statusBar.classList.remove("success","warn");
        if (kind === "success") $statusBar.classList.add("success");
        if (kind === "warn")    $statusBar.classList.add("warn");
        clearTimeout(statusTimer);
        statusTimer = setTimeout(() => {
          $statusMsg.textContent = "Sistema listo.";
          $statusBar.classList.remove("success","warn");
        }, 15000);
      }

      /* INTERFAZ */
      function buildUI() {
        const trHead = document.createElement("tr");
        const thEdit = document.createElement("th"); thEdit.textContent = "✏️";
        trHead.appendChild(thEdit);
        COLS.forEach(c => {
          const th = document.createElement("th"); th.textContent = c;
          trHead.appendChild(th);
        });
        $thead.appendChild(trHead);
        const fc = document.getElementById("filtros-container");
        const row = document.createElement("div");
        row.style.cssText = "display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px";
        COLS.forEach(col => {
          const lab = document.createElement("label");
          lab.style.cssText = "display:flex;flex-direction:column;font-size:12px;color:#fff";
          lab.textContent = col;
          let inp;
          if (col === "Actualizado") {
            inp = document.createElement("input");
            flatpickr(inp, { dateFormat: "Y-m-d", onChange: () => { page = 1; render(); } });
          } else if (col === "RM" || col === "Asunto") {
            inp = document.createElement("input");
            inp.placeholder = "Buscar…";
            inp.oninput = () => { page = 1; render(); };
          } else {
            inp = document.createElement("select");
            inp.innerHTML = "<option value=''>-- Todos --</option>";
            inp.onchange = () => { page = 1; render(); };
          }
          filtros.push({ col, input: inp });
          lab.appendChild(inp);
          row.appendChild(lab);
        });
        fc.appendChild(row);
        refreshFilterOptions();
        $fileIssues.onchange = () => {
          if ($fileIssues.files.length) importarIssues($fileIssues.files[0]);
        };
        $btnSaveGit.onclick = () => setStatus("Guardado local (sin Git).","success");
        document.getElementById("btnResetBD").onclick = () => {
          if (confirm("¿Seguro que querés borrar la BD local y reiniciar la sincronización?")) {
            localStorage.removeItem(LS_KEY_DATA);
            location.reload();
          }
        };
        $btnNuevo.onclick = () => openModal("modalNuevo");
        $chkHide.onchange = () => { page = 1; render(); }; 
      $chkHideBacklog.onchange = () => { page = 1; render(); };
        $btnReset.onclick = () => {
          filtros.forEach(f => f.input.value = "");
          page = 1; render();
        };
        document.getElementById("nrGuardar").onclick = altaNuevo;
      }

      /* RENDER */
      function render() {
        const filtered = data.filter(r => {
          if ($chkHide.checked && (r["ESTADO INTERNO"]||"").includes("CERRADOS / En PROD.")) return false;
            if ($chkHideBacklog.checked && (r["ESTADO INTERNO"]||"").includes("En Análisis | BACKLOG")) return false;
          return filtros.every(({col,input}) => {
            if (!input.value) return true;
            let val = "";
            if (col === "TAGS") val = r["TAGS"] || "";
            else if (col === "FUNCIONAL Monitoreo") val = r["FUNCIONAL Monitoreo"] || "";
            else val = r[col] != null ? r[col].toString() : "";
            return val.toLowerCase().includes(input.value.toLowerCase());
          });
        });

        const pages = Math.max(1, Math.ceil(filtered.length / ROWS_X_PAG));
        if (page > pages) page = pages;
        const slice = filtered.slice((page-1)*ROWS_X_PAG, page*ROWS_X_PAG);

        $tbody.innerHTML = "";
        if (!slice.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="${COLS.length+1}" style="text-align:center;color:#ff7675;font-weight:bold">Sin resultados</td>`;
          $tbody.appendChild(tr);
        } else {
          slice.forEach(r => {
            const tr = document.createElement("tr");
            if (r._updated) tr.classList.add("updated");
            addEditButton(tr, r);
            COLS.forEach(c => {
              const td = document.createElement("td");
              if (c === "RM") {
                const a = document.createElement("a");
                a.href = `https://redmine.dguiaf-gcba.gov.ar/issues/${r[c]}`;
                a.className = "rm-link"; a.target = "_blank";
                a.textContent = r[c];
                td.appendChild(a);
              }
              else if (c === "TAGS") {
                (r["TAGS"]||"").match(/\[(.*?)\]/g)?.forEach(t => {
                  const s = document.createElement("span");
                  s.className = "tag-label";
                  s.textContent = t.replace(/\[|\]/g,"");
                  td.appendChild(s);
                });
              }
              else if (c === "SISTEMA") {
                const span = document.createElement("span");
                span.className = "tag-label";
                span.textContent = r[c];
                if (r[c] === "CIUDAD") {
                  span.style.background = "#ffeb3b";
                  span.style.color = "#000";
                } else if (r[c] === "OBSBA") {
                  span.style.background = "#4fc3f7";
                  span.style.color = "#fff";
                }
                td.appendChild(span);
              } else {
                td.textContent = r[c] || "";
              }
              tr.appendChild(td);
            });
            $tbody.appendChild(tr);
          });
        }

        $pag.innerHTML = "";
        $pag.appendChild(btnPg("« Prev", ()=>{ page--; render(); }, page===1));
        for (let i=1; i<=pages; i++) {
          $pag.appendChild(btnPg(i, ()=>{ page=i; render(); }, i===page));
        }
        $pag.appendChild(btnPg("Next »", ()=>{ page++; render(); }, page===pages));
      }

      function btnPg(text, cb, disabled) {
        const b = document.createElement("button");
        b.textContent = text;
        b.disabled = disabled;
        b.onclick = cb;
        return b;
      }

      /* FILTROS DINÁMICOS */
      function refreshFilterOptions() {
        filtros.forEach(({col,input}) => {
          if (input.tagName !== "SELECT") return;
          const sel = input.value;
          const opts = new Set();
          data.forEach(r => {
            let cell = "";
            if (col === "TAGS") cell = r["TAGS"]||"";
            else if (col === "FUNCIONAL Monitoreo") cell = r["FUNCIONAL Monitoreo"]||"";
            else cell = r[col]||"";
            if (!cell) return;
            if (col === "TAGS") {
              cell.match(/\[(.*?)\]/g)?.forEach(t => 
                opts.add(t.replace(/\[|\]/g,"")));
            } else if (col === "FUNCIONAL Monitoreo") {
              const m = cell.match(/\|(.*?)\|/);
              if (m) opts.add(m[1]);
            } else {
              opts.add(cell);
            }
          });
          input.innerHTML = "<option value=''>-- Todos --</option>";
          [...opts].sort().forEach(v => {
            const o = document.createElement("option");
            o.value = v; o.textContent = v;
            if (v === sel) o.selected = true;
            input.appendChild(o);
          });
        });
      }

      /* EDICIÓN */
      function addEditButton(tr, reg) {
        const td = document.createElement("td");
        td.textContent = "✏️"; td.style.cursor = "pointer";
        td.onclick = () => openEditor(reg);
        tr.appendChild(td);
      }
      function openEditor(reg) {
        document.getElementById("edSis").value = reg["SISTEMA"];
        const tagsArr = (reg["TAGS"]||"")
          .match(/\[(.*?)\]/g)
          ?.map(t=>t.replace(/\[|\]/g,""))
          .join(", ") || "";
        document.getElementById("edTags").value = tagsArr;
        
        openModal("modalEdit");

        document.getElementById("edGuardar").onclick = () => {
          reg["SISTEMA"] = document.getElementById("edSis").value;
          const T = document.getElementById("edTags").value
            .split(",").map(t=>t.trim()).filter(Boolean);
          reg["TAGS"] = T.map(t=>`[${t}]`).join("");
          reg["Actualizado"] = new Date().toISOString().split("T")[0];
          persistLocal("✔ Registro editado.");
          cerrarModal("modalEdit");
          render();
          syncGit();
        };
      }

      /* NUEVO */
      function altaNuevo() {
        const rm  = parseInt(document.getElementById("nrRM").value,10);
        const sis = document.getElementById("nrSis").value;
        if (!rm || isNaN(rm)) {
          setStatus("⚠ RM obligatorio y numérico.","warn");
          return;
        }
        if (data.some(r=>r.RM==rm)) {
          setStatus("⚠ RM duplicado.","warn");
          return;
        }
        data.push({
          "SISTEMA": sis,
          "ESTADO INTERNO": "",
          "RM": rm,
          "Asunto": "",
          "Estado": "",
          "Prioridad": "",
          "Asignado a": "",
          "Actualizado": new Date().toISOString().split("T")[0],
          
          "TAGS": ""
        });
        persistLocal("✔ Nuevo RM guardado.");
        cerrarModal("modalNuevo");
        render();
        syncGit();
      }

      /* IMPORTAR CSV */
      const EQ = {
        "B- Completo"           : "CERRADOS / En PROD.",
        "B- Rechazado"          : "CERRADOS / En PROD.",
        "E-Alcance"             : "En Análisis | BACKLOG",
        "E-Backlog"             : "En Análisis | BACKLOG",
        "E-Cancelada"           : "CERRADOS / En PROD.",
        "E-Desarrollo"          : "En Desarrollo | EN CURSO",
        "E-Produccion"          : "CERRADOS / En PROD.",
        "E-Stand By"            : "En Análisis | BACKLOG",
        "E-Test Funcional"      : "En Prueba Func. | EN CURSO",
        "E-Test QA"             : "En Prueba QA | EN CURSO",
		"E-Analisis"			: "En Análisis | EN CURSO",
        "MDA-AnAAlisis"         : "En Análisis | EN CURSO",
        "MDA-AnAlisis"          : "En Análisis | EN CURSO",
        "MDA-Analisis"          : "En Análisis | EN CURSO",
		"MDA-An�lisis"          : "En Análisis | EN CURSO",
        "MDA-Análisis"          : "En Análisis | EN CURSO",
        "MDA-Cerrado"           : "CERRADOS / En PROD.",
        "MDA-Desarrollo"        : "En Desarrollo | EN CURSO",
        "MDA-Pasaje PROD"       : "Solicitud de Pasaje a PROD.",
        "MDA-Pendiente usuario" : "Solicitud de Pasaje a PROD.",
        "MDA-Rechazado"         : "CERRADOS / En PROD.",
        "MDA-Resuelto"          : "CERRADOS / En PROD.",
        "MDA-Test QA"           : "En Prueba QA | EN CURSO",
        "MDA-Test funcional"    : "En Prueba Func. | EN CURSO",
        "R- Backlog"            : "En Análisis | BACKLOG",
        "R- En curso"           : "En Análisis | EN CURSO",
        "T-Cancelada"           : "CERRADOS / En PROD.",
        "T-Finalizada"          : "CERRADOS / En PROD.",
        "T-En Curso"            : "En Análisis | EN CURSO",
        "T-Pasaje a Producción" : "Solicitud de Pasaje a PROD.",
        "T-Pasaje a Produccion" : "Solicitud de Pasaje a PROD.",
        "T-Stand By"            : "En Análisis | BACKLOG",
        "T-Solicitud de pasaje" : "Solicitud de Pasaje a PROD."
      };
      function importarIssues(file) {
        setStatus("⏳ Analizando issues.csv…");
        const reader = new FileReader();
        reader.onload = async e => {
          let contenido = e.target.result;
          let parsed;
          let delimitador = ";";
          parsed = Papa.parse(contenido, { header: true, skipEmptyLines: true, delimiter: delimitador });
          if (parsed.meta.fields.length === 1) {
            delimitador = ",";
            parsed = Papa.parse(contenido, { header: true, skipEmptyLines: true, delimiter: delimitador });
          }
          const camposEsperados = {"#": null,"asunto": null,"estado": null,"prioridad": null,"asignado a": null,"actualizado": null};
          const normalizar = str => (str || "").toLowerCase().trim();
          const camposDetectados = parsed.meta.fields.reduce((acc, h) => {
            acc[normalizar(h)] = h;
            return acc;
          }, {});
          for (const clave in camposEsperados) {
            if (!(clave in camposDetectados)) {
              setStatus("⚠ Faltan columnas requeridas: " + clave, "warn");
              return;
            }
            camposEsperados[clave] = camposDetectados[clave];
          }
          const issues = parsed.data;
          const map = new Map(data.map(r => [String(r.RM).trim(), r]));
          let actualizados = 0;
          const limpiar = v => (v ?? "").toString().toLowerCase().trim();
          issues.forEach(is => {
            const rm = String(parseInt(is[camposEsperados["#"]])).trim();
            if (!rm) return;
            const reg = map.get(rm);
            if (!reg) return;
            let cambios = false;
            const campos = ["actualizado", "estado", "prioridad", "asignado a", "asunto"];
            campos.forEach(c => {
              const nuevo = limpiar(is[camposEsperados[c]]);
              const actual = limpiar(reg[c.charAt(0).toUpperCase() + c.slice(1)]);
              if (nuevo !== actual) {
                reg[c.charAt(0).toUpperCase() + c.slice(1)] = is[camposEsperados[c]];
                cambios = true;
              }
            });
            const estadoOriginal = is[camposEsperados["estado"]];
            const mapeado = EQ[estadoOriginal] || reg["ESTADO INTERNO"];
            if ((reg["ESTADO INTERNO"] || "").trim() !== (mapeado || "").trim()) {
              reg["ESTADO INTERNO"] = mapeado;
              cambios = true;
            }
            if (cambios) {
              reg._updated = true;
              actualizados++;
            }
          });
          if (actualizados > 0) {
            persistLocal(`✔ ${actualizados} registro(s) actualizado(s).`);
            render();
            syncGit();
          } else {
            setStatus("ℹ No hubo cambios.");
          }
        };
        reader.readAsText(file);
      }

      /* PERSISTENCIA / SYNC */
      function persistLocal(msg) {
        localStorage.setItem(LS_KEY_DATA, JSON.stringify(data));
        refreshFilterOptions();
        setStatus(msg,"success");
      }
      async function syncGit() {
        setStatus("💾 Datos guardados localmente.");
      ","success");
      }

      /* RELOAD desde GitHub */
      window.forzarRecarga = async function() {
        setStatus("⏳ Recargando desde GitHub…");
        try {
          const raw = await fetchRawCSV();
          data = csvToArray(raw);
          localStorage.setItem(LS_KEY_DATA, JSON.stringify(data));
          setStatus("✅ Datos recargados de GitHub","success");
          render();
        } catch (e) {
          setStatus("⚠ Error al recargar desde GitHub","warn");
        }
      };

      /* UTILIDADES */
      function csvToArray(txt) {
        const [hdr, ...lines] = txt.trim().split(/\r?\n/);
        const cols = hdr.split(",");
        return lines.map(l => {
          const v = l.split(",");
          const obj = {};
          cols.forEach((c,i) => { obj[c] = v[i]||""; });
          return obj;
        });
      }
      async function fetchRawCSV() {
        const r = await fetch(RAW_CSV_URL);
        if (!r.ok) throw Error("Descarga CSV");
        return await r.text();
      }?ref=${GH_BRANCH}`, {
          headers: {
            Authorization: `token ${GH_TOKEN}`,
            Accept: "application/vnd.github.v3.raw"
          }
        });
        if (!r.ok) throw Error("Descarga Git");
        return await r.text();
      }

      window.openModal = function(id) {
        document.getElementById(id).style.display = "block";
        document.getElementById("modalOverlay").style.display = "block";
      };
      window.closeModal = function(id) {
        document.getElementById(id).style.display = "none";
        document.getElementById("modalOverlay").style.display = "none";
      };
      window.cerrarModal = window.closeModal;

      /* RECOMPOSICIÓN DE ESTADOS INTERNOS */
      window.recomponerEstadosInternos = function() {
        const mapeoEstados = {
          "B- Completo": "CERRADOS / En PROD.",
          /* ... resto del mapeo ... */
        };
        let cambios = 0;
        for (const reg of data) {
          const nuevo = mapeoEstados[reg["Estado"]];
          if (nuevo && reg["ESTADO INTERNO"] !== nuevo) {
            reg["ESTADO INTERNO"] = nuevo;
            cambios++;
          }
        }
        if (cambios) {
          persistLocal(`✔ ${cambios} estado(s) interno(s) actualizados.`);
          render();
          syncGit();
        } else {
          setStatus("ℹ Todos los estados internos ya estaban correctos.");
        }
      };
    });
  </script>
<!-- ======== TABLERO ASIGNACIONES ======== -->
<!-- ======== TABLERO ASIGNACIONES ======== -->
<h2 style="margin:40px 0 10px;color:#ffd54f;font-size:20px;font-weight:bold;font-family:'Segoe UI',sans-serif;">Tablero de Asignaciones</h2>
<!-- TABLERO ASIGNACIONES (embed) -->
<iframe loading="lazy" srcdoc="&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;es&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;/&gt;
  &lt;title&gt;Asignaciones&lt;/title&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css&quot;/&gt;
  &lt;style&gt;
    html, body { height:100%; margin:0; overflow:hidden; font-family:'Segoe UI', sans-serif; background-color:#1e1e2f; color:#f0f0f0; }
    .status-bar { position:fixed; top:0; left:0; right:0; height:48px; display:flex; align-items:center; justify-content:space-between; padding:0 16px; background:#282840; border-bottom:1px solid #4a4a65; font-size:14px; font-weight:bold; z-index:1000; }
    #board { position:absolute; top:48px; bottom:0; left:0; right:0; display:flex; overflow-x:auto; overflow-y:hidden; padding:16px; gap:12px; }
    .column { background:#2c2c3c; border-radius:3px; flex:0 0 260px; display:flex; flex-direction:column; height:100%; }
    .column-header { padding:8px; display:flex; align-items:center; justify-content:space-between; font-size:14px; font-weight:bold; color:#f0f0f0; background:#323248; border-bottom:2px solid #444; }
    .column-header .header-left { display:flex; align-items:center; }
    .column-header .header-left i { margin-right:8px; }
    .column-header .header-counts { font-size:12px; }
    .column-content { flex:1; overflow-y:auto; padding:8px; }
    .card { background:#3a3a50; border-radius:3px; padding:8px; margin-bottom:8px; box-shadow:0 1px 0 rgba(0,0,0,.2); font-size:13px; line-height:1.4; color:#f0f0f0; transition:opacity .3s; }
    .card a { color:#4fc3f7; text-decoration:none; font-weight:bold; }
    .card a:hover { text-decoration:underline; }
    .badge { display:inline-block; margin:4px 4px 0 0; padding:2px 6px; font-size:11px; border-radius:3px; background:#0079bf; color:#fff; }

    .card.transparent { opacity:0.4; }
    .card:not(.transparent) { background:#50507a; } /* resaltado */
    .num-big { font-size:18px; font-weight:bold; color:#ffd54f; }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class=&quot;status-bar&quot;&gt;
    &lt;span&gt;Asignaciones&lt;/span&gt;
    &lt;span id=&quot;statusCounts&quot;&gt;&lt;/span&gt;
    &lt;span id=&quot;statusClock&quot;&gt;&lt;/span&gt;
  &lt;/div&gt;
  &lt;div id=&quot;board&quot;&gt;&lt;/div&gt;

  &lt;script src=&quot;https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js&quot;&gt;&lt;/script&gt;
  &lt;script&gt;
    const RAW_CSV_URL = window.parent.RAW_CSV_URL;
    const LS_KEY    = &quot;BD_RM&quot;;

    const ordenEstados = [
      &quot;En Análisis | EN CURSO&quot;,
      &quot;En Prueba QA | EN CURSO&quot;,
      &quot;En Desarrollo | EN CURSO&quot;,
      &quot;En Prueba Func. | EN CURSO&quot;,
      &quot;Solicitud de Pasaje a PROD.&quot;,
      &quot;En Análisis | BACKLOG&quot;
    ];
    
const MonitoreosOriginales = [
      &quot;Dario Elola&quot;,&quot;Franchesca Gabriela Rivas Veliz&quot;,&quot;Vanina Zylberg&quot;,
      &quot;Carolina Noemi Gualdi&quot;,&quot;Valentina Juszkiewicz&quot;,&quot;Renzo Antonioli&quot;,
      &quot;Nelson Daniel Bordon&quot;,&quot;Lucas Gutierrez&quot;,&quot;Nancy Andrea Martinez&quot;
    ];

// Normalizar y agrupar por nombre sin tilde
const mapaMonitoreos = {};
MonitoreosOriginales.forEach(nombre =&gt; {
  const clave = normalizarNombre(nombre);
  if (!mapaMonitoreos[clave]) mapaMonitoreos[clave] = nombre;
});
const Monitoreos = Object.values(mapaMonitoreos);


    function tickClock() {
      const now   = new Date();
      const fecha = now.toLocaleDateString('es-AR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      const hora  = now.toLocaleTimeString('es-AR',{hour12:false});
      document.getElementById('statusClock').textContent = `${fecha} | ${hora}`;
    }
    tickClock();
    setInterval(tickClock,1000);

    function normalizarNombre(nombre) {
      return nombre.normalize(&quot;NFD&quot;).replace(/[\u0300-\u036f]/g, &quot;&quot;);
    }

    document.addEventListener('DOMContentLoaded', async () =&gt; {
      let data = [];
      const raw = localStorage.getItem(LS_KEY);
      if (raw) { try { data = JSON.parse(raw); } catch {} }
      if (!data.length) {
        const resp = await fetch(`${GH_URL}?ref=${GH_BRANCH}`,{
          headers:{Authorization:`token ${GH_TOKEN}`,Accept:&quot;application/vnd.github.v3.raw&quot;}
        });
        const csvText = await resp.text();
        data = Papa.parse(csvText,{header:true,skipEmptyLines:true}).data;
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }

      /* Totales generales */
      const totalAsig = Monitoreos.reduce((sum,res)=&gt;
        sum + data.filter(r =&gt;
          r['Asignado a']?.trim()===res &amp;&amp;
          ordenEstados.includes(r['ESTADO INTERNO']?.trim())
        ).length
      ,0);

      const totalTra = Monitoreos.reduce((sum,res)=&gt;
        sum + data.filter(r =&gt;
          r['Asignado a']?.trim()===res &amp;&amp;
          r['TAGS']?.includes(`[${res}]`) &amp;&amp;
          ordenEstados.includes(r['ESTADO INTERNO']?.trim())
        ).length
      ,0);

      document.getElementById('statusCounts').innerHTML = '';

      const board = document.getElementById('board');

      Monitoreos.forEach(Monitoreo =&gt; {
        const assignedCount = data.filter(r =&gt;
          normalizarNombre(r['Asignado a']?.trim())===normalizarNombre(Monitoreo) &amp;&amp;
          ordenEstados.includes(r['ESTADO INTERNO']?.trim())
        ).length;

        
const tagCount = data.filter(r =&gt;
  (r['TAGS']?.includes(`[${Monitoreo}]`) || r['TAGS']?.includes(`[${normalizarNombre(Monitoreo)}]`)) &amp;&amp;
  ordenEstados.includes(r['ESTADO INTERNO']?.trim())
).length;
const workingCount = Math.max(0, tagCount - assignedCount);


        const col = document.createElement('div');
        col.className = 'column';
        col.innerHTML = `
  &lt;div style=&quot;padding:4px 8px;font-size:12px;&quot;&gt;
    🧑‍💼 &lt;strong&gt;Asignados:&lt;/strong&gt; &lt;span class=&quot;num-big&quot;&gt;${assignedCount}&lt;/span&gt;
    &amp;nbsp;&amp;nbsp;&amp;nbsp;
    👀 &lt;strong&gt;Monitoreo:&lt;/strong&gt; &lt;span class=&quot;num-big&quot;&gt;${workingCount}&lt;/span&gt;
  &lt;/div&gt;
  &lt;div class=&quot;column-header&quot;&gt;
    &lt;div class=&quot;header-left&quot;&gt;&lt;i class=&quot;fas fa-user&quot;&gt;&lt;/i&gt;${Monitoreo}&lt;/div&gt;
  &lt;/div&gt;
  &lt;div class=&quot;column-content&quot;&gt;&lt;/div&gt;
`;
        const contentDiv = col.querySelector('.column-content');

        const tarjetas = data.filter(r =&gt;
          ordenEstados.includes(r['ESTADO INTERNO']?.trim()) &amp;&amp;
          (normalizarNombre(r['Asignado a']?.trim())===normalizarNombre(Monitoreo) || r['TAGS']?.includes(`[${Monitoreo}]`) || r['TAGS']?.includes(`[${normalizarNombre(Monitoreo)}]`))
        );

        const dobles = tarjetas.filter(r =&gt;
          normalizarNombre(r['Asignado a']?.trim())===normalizarNombre(Monitoreo) &amp;&amp;
          r['TAGS']?.includes(`[${Monitoreo}]`) || r['TAGS']?.includes(`[${normalizarNombre(Monitoreo)}]`)
        );
        const simples = tarjetas.filter(r =&gt; !dobles.includes(r));

        const ordenSort = (a,b) =&gt; {
          const eA = ordenEstados.indexOf(a['ESTADO INTERNO']);
          const eB = ordenEstados.indexOf(b['ESTADO INTERNO']);
          if (eA!==eB) return eA-eB;
          const pA = parseInt(a['TAGS'].match(/P(\d+)/)?.[1]||Infinity,10);
          const pB = parseInt(b['TAGS'].match(/P(\d+)/)?.[1]||Infinity,10);
          if (pA!==pB) return pA-pB;
          return parseInt(a['RM'],10)-parseInt(b['RM'],10);
        };
        dobles.sort(ordenSort);
        simples.sort((a,b)=&gt;{ const eA=ordenEstados.indexOf(a['ESTADO INTERNO']); const eB=ordenEstados.indexOf(b['ESTADO INTERNO']); if(eA!==eB)return eA-eB; return parseInt(a['RM'],10)-parseInt(b['RM'],10); });

        
        const tarjetasOrdenadas = tarjetas.slice().sort((a, b) =&gt; {
          const esDobleA = (
            normalizarNombre(a['Asignado a']?.trim()) === normalizarNombre(Monitoreo) &amp;&amp;
            (a['TAGS']?.includes(`[${Monitoreo}]`) || a['TAGS']?.includes(`[${normalizarNombre(Monitoreo)}]`))
          );
          const esDobleB = (
            normalizarNombre(b['Asignado a']?.trim()) === normalizarNombre(Monitoreo) &amp;&amp;
            (b['TAGS']?.includes(`[${Monitoreo}]`) || b['TAGS']?.includes(`[${normalizarNombre(Monitoreo)}]`))
          );
          if (esDobleA &amp;&amp; !esDobleB) return -1;
          if (!esDobleA &amp;&amp; esDobleB) return 1;

          const sistemaOrden = s =&gt; s === 'CIUDAD' ? 0 : s === 'OBSBA' ? 1 : 2;
          const sA = sistemaOrden(a['SISTEMA']);
          const sB = sistemaOrden(b['SISTEMA']);
          if (sA !== sB) return sA - sB;

          return parseInt(a['RM'], 10) - parseInt(b['RM'], 10);
        });

        tarjetasOrdenadas.forEach(r =&gt; {
    
          const card = document.createElement('div');
          card.className = 'card';
          const matchAssigned = normalizarNombre(r['Asignado a']?.trim())===normalizarNombre(Monitoreo);
          const matchTag      = r['TAGS']?.includes(`[${Monitoreo}]`) || r['TAGS']?.includes(`[${normalizarNombre(Monitoreo)}]`);
          if (!(matchAssigned &amp;&amp; matchTag)) card.classList.add('transparent');
          card.innerHTML = `
            &lt;a href=&quot;https://redmine.dguiaf-gcba.gov.ar/issues/${r['RM']}&quot; target=&quot;_blank&quot;&gt;${r['RM']}&lt;/a&gt;
            &lt;div&gt;${r['Asunto']||''}&lt;/div&gt;
          `;
          if (matchAssigned &amp;&amp; matchTag) {
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = Monitoreo;
            card.appendChild(badge);
          }
          const bi = document.createElement('span');
          bi.className = 'badge';
          bi.textContent = r['ESTADO INTERNO']||''; card.appendChild(bi);
          const be = document.createElement('span');
          be.className = 'badge';
          be.textContent = r['Estado']||''; card.appendChild(be);

          const sistema = (r['SISTEMA'] || '').trim();
          if (sistema === &quot;OBSBA&quot;) {
            const sBadge = document.createElement('span');
            sBadge.className = 'badge';
            sBadge.style.background = '#4fc3f7';
            sBadge.style.color = '#fff';
            sBadge.textContent = 'OBSBA';
            card.appendChild(sBadge);
          } else if (sistema === &quot;CIUDAD&quot;) {
            const sBadge = document.createElement('span');
            sBadge.className = 'badge';
            sBadge.style.background = '#ffeb3b';
            sBadge.style.color = '#000';
            sBadge.textContent = 'CIUDAD';
            card.appendChild(sBadge);
          }

          contentDiv.appendChild(card);
        });

        board.appendChild(col);
      });
    });
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
" style="width:100%;border:none;height:650px;"></iframe>
<footer style="text-align:center; margin-top:20px;">
  © 2025 Derechos reservados. Versión V22052025.1
</footer>
</body>
</html>